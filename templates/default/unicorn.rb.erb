config_file = '<%= ::File.join(@current_path, 'config', 'unicorn.rb') %>'
instance_eval(File.read(config_file), config_file) if File.exists?(config_file)

working_directory '<%= @current_path %>'
pid '<%= @pid_file %>'

preload_app true
timeout 60
worker_processes <%= @workers %>

# Support zero-downtime deploys
before_fork do |server, worker|
  File.open('<%= @monit_pid_file %>', 'w') { |f| f.write("#{File.read(server.pid).to_i}\n") }
  old_pid = "#{server.config[:pid]}.oldbin"
  if File.exists?(old_pid) && server.pid != old_pid
    begin
      Process.kill('QUIT', File.read(old_pid).to_i)
    rescue Errno::ENOENT, Errno::ESRCH
    end
  end
end
